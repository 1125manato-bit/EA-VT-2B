name: Build Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up CMake
      uses: jwlawrence/actions-setup-cmake@v2

    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build with build.bat
      shell: cmd
      run: |
        cd Project_Source
        call build.bat Release

    - name: Build Installer (Inno Setup)
      shell: cmd
      run: |
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Project_Source\installer_windows.iss

    - name: Prepare Artifacts
      shell: cmd
      run: |
        mkdir release
        xcopy /s Project_Source\build\EA_VT_2B_artefacts\Release\VST3\*.vst3 release\VST3\ /Y /I
        copy Project_Source\installer\EA_VT-2B_Installer_Windows.exe release\ /Y
        dir release

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EA-VT-2B-Windows-Release
        path: release/
