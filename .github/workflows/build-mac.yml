name: Build macOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up CMake
      uses: jwlawrence/actions-setup-cmake@v2

    - name: Build with build.sh
      run: |
        cd Project_Source
        chmod +x build.sh
        ./build.sh Release

    - name: Import Certificate
      if: secrets.MACOS_CERTIFICATE != ''
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # cert import
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # import certificate
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

        # create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # import certificate to keychain
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t agg -k $KEYCHAIN_PATH
        security list-keychains -s $KEYCHAIN_PATH
        security find-identity -v -p codesigning

    - name: Sign Plugin Binaries
      if: secrets.MACOS_CERTIFICATE != ''
      env:
         TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # sign vst3 and component
        codesign --deep --force --verbose --options=runtime --sign "Developer ID Application" "Project_Source/build/EA_VT_2B_artefacts/Release/VST3/EA VT-2B.vst3"
        codesign --deep --force --verbose --options=runtime --sign "Developer ID Application" "Project_Source/build/EA_VT_2B_artefacts/Release/AU/EA VT-2B.component"

    - name: Build Package (.pkg)
      run: |
        mkdir -p pkg_root/Library/Audio/Plug-Ins/VST3
        mkdir -p pkg_root/Library/Audio/Plug-Ins/Components
        cp -R Project_Source/build/EA_VT_2B_artefacts/Release/VST3/EA\ VT-2B.vst3 pkg_root/Library/Audio/Plug-Ins/VST3/
        cp -R Project_Source/build/EA_VT_2B_artefacts/Release/AU/EA\ VT-2B.component pkg_root/Library/Audio/Plug-Ins/Components/
        
        # Build package (unsigned initially)
        pkgbuild --identifier "com.emuaudio.ea-vt2b.pkg" \
                 --version "1.1.0" \
                 --root pkg_root \
                 --install-location / \
                 EA_VT-2B_Installer_macOS_unsigned.pkg

    - name: Sign Installer Package
      if: secrets.MACOS_CERTIFICATE != ''
      run: |
        productsign --sign "Developer ID Installer" \
                    EA_VT-2B_Installer_macOS_unsigned.pkg \
                    EA_VT-2B_Installer_macOS.pkg

    - name: Notarize Package
      if: secrets.APPLE_ID != '' && secrets.APPLE_APP_SPECIFIC_PASSWORD != '' && secrets.APPLE_TEAM_ID != ''
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APP_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        xcrun notarytool submit EA_VT-2B_Installer_macOS.pkg \
          --apple-id "$APPLE_ID" \
          --password "$APP_PASSWORD" \
          --team-id "$TEAM_ID" \
          --wait

    - name: Staple Ticket
      if: secrets.APPLE_ID != ''
      run: |
        xcrun stapler staple EA_VT-2B_Installer_macOS.pkg

    - name: Rename Unsigned Package (if signing skipped)
      if: secrets.MACOS_CERTIFICATE == ''
      run: |
        mv EA_VT-2B_Installer_macOS_unsigned.pkg EA_VT-2B_Installer_macOS.pkg

    - name: Prepare Artifacts
      run: |
        mkdir release
        cp EA_VT-2B_Installer_macOS.pkg release/
        find Project_Source/build -name "*.vst3" -o -name "*.component" -exec cp -R {} release/ \;
        ls -R release

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EA-VT-2B-macOS-Release
        path: release/
