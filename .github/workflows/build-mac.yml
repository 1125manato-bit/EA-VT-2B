name: Build macOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up CMake
      uses: jwlawrence/actions-setup-cmake@v2

    - name: Build with build.sh
      run: |
        cd Project_Source
        chmod +x build.sh
        ./build.sh Release

    - name: Build Package (.pkg)
      run: |
        mkdir -p pkg_root/Library/Audio/Plug-Ins/VST3
        mkdir -p pkg_root/Library/Audio/Plug-Ins/Components
        cp -R Project_Source/build/EA_VT_2B_artefacts/Release/VST3/EA\ VT-2B.vst3 pkg_root/Library/Audio/Plug-Ins/VST3/
        cp -R Project_Source/build/EA_VT_2B_artefacts/Release/AU/EA\ VT-2B.component pkg_root/Library/Audio/Plug-Ins/Components/
        
        pkgbuild --identifier "com.emuaudio.ea-vt2b.pkg" \
                 --version "1.1.0" \
                 --root pkg_root \
                 --install-location / \
                 EA_VT-2B_Installer_macOS.pkg

    - name: Prepare Artifacts
      run: |
        mkdir release
        cp EA_VT-2B_Installer_macOS.pkg release/
        find Project_Source/build -name "*.vst3" -o -name "*.component" -exec cp -R {} release/ \;
        ls -R release

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EA-VT-2B-macOS-Release
        path: release/
